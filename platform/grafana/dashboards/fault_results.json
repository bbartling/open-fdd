{
  "uid": "fault-results",
  "title": "Fault Results (open-fdd)",
  "schemaVersion": 42,
  "time": { "from": "now-7d", "to": "now" },
  "panels": [
    {
      "type": "stat",
      "title": "Fault Runner Status",
      "gridPos": { "x": 0, "y": 0, "w": 4, "h": 4 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "table",
          "rawSql": "SELECT COALESCE((SELECT status FROM fdd_run_log ORDER BY run_ts DESC LIMIT 1), 'never') AS value",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [
            { "type": "value", "options": { "ok": { "text": "OK", "color": "green" } } },
            { "type": "value", "options": { "error": { "text": "Error", "color": "red" } } },
            { "type": "value", "options": { "never": { "text": "Never", "color": "gray" } } }
          ]
        }
      }
    },
    {
      "type": "stat",
      "title": "Fault Runner â€” Last ran",
      "gridPos": { "x": 4, "y": 0, "w": 8, "h": 4 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "table",
          "rawSql": "SELECT (SELECT EXTRACT(EPOCH FROM run_ts)::bigint * 1000 FROM fdd_run_log ORDER BY run_ts DESC LIMIT 1) AS value",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "dateTimeFromNow"
        }
      }
    },
    {
      "type": "stat",
      "title": "Weather faults (time range)",
      "gridPos": { "x": 12, "y": 0, "w": 4, "h": 4 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "table",
          "rawSql": "SELECT COALESCE(SUM(flag_value), 0)::bigint AS value FROM fault_results WHERE fault_id IN ('fault_temp_stuck','fault_rh_out_of_range','fault_temp_spike','fault_gust_lt_wind') AND $__timeFilter(ts)",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1, "color": "yellow" }
            ]
          }
        }
      }
    },
    {
      "type": "stat",
      "title": "Fault count (time range)",
      "gridPos": { "x": 16, "y": 0, "w": 4, "h": 4 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "table",
          "rawSql": "SELECT COALESCE(SUM(flag_value), 0)::bigint AS value FROM fault_results WHERE $__timeFilter(ts)",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "color": { "mode": "thresholds" },
          "thresholds": {
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1, "color": "yellow" },
              { "value": 10, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "text",
      "title": "",
      "gridPos": { "x": 20, "y": 0, "w": 4, "h": 4 },
      "options": {
        "content": "**No data?** FDD runs every few hours. Weather faults from Open-Meteo.",
        "mode": "markdown"
      }
    },
    {
      "type": "timeseries",
      "title": "Fault flags by fault_id",
      "gridPos": { "x": 0, "y": 4, "w": 24, "h": 10 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "time_series",
          "rawSql": "SELECT ts AS time, fault_id AS metric, SUM(flag_value) AS value FROM fault_results WHERE $__timeFilter(ts) GROUP BY ts, fault_id ORDER BY ts",
          "refId": "A"
        }
      ]
    },
    {
      "type": "timeseries",
      "title": "Faults by equipment",
      "gridPos": { "x": 0, "y": 14, "w": 24, "h": 10 },
      "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
      "targets": [
        {
          "format": "time_series",
          "rawSql": "SELECT ts AS time, fault_id AS metric, flag_value AS value FROM fault_results WHERE ('$equipment' = '' OR equipment_id = '$equipment') AND $__timeFilter(ts) ORDER BY ts",
          "refId": "A"
        }
      ]
    }
  ],
  "templating": {
    "list": [
      {
        "name": "equipment",
        "type": "query",
        "datasource": { "type": "postgres", "uid": "openfdd_timescale" },
        "query": "SELECT equipment_id AS __text, equipment_id AS __value FROM fault_results WHERE equipment_id != '' GROUP BY equipment_id UNION ALL SELECT 'All', '' ORDER BY __value",
        "refresh": 1,
        "includeAll": false,
        "current": { "text": "All", "value": "" }
      }
    ]
  }
}
