{
  "uid": "system-resources",
  "title": "System Resources (Host & Containers)",
  "schemaVersion": 42,
  "time": { "from": "now-6h", "to": "now" },
  "refresh": "30s",
  "panels": [
    {
      "type": "stat",
      "title": "Host memory used",
      "gridPos": {"x": 0, "y": 0, "w": 4, "h": 4},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "table",
        "rawSql": "SELECT (mem_used_bytes / 1024.0 / 1024 / 1024)::numeric(10,2) AS value FROM host_metrics WHERE $__timeFilter(ts) ORDER BY ts DESC LIMIT 1",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "decgbytes",
          "color": {"mode": "thresholds"},
          "thresholds": {"steps": [{"value": null, "color": "green"}, {"value": 6, "color": "yellow"}, {"value": 7, "color": "red"}]}
        }
      }
    },
    {
      "type": "stat",
      "title": "Host memory available",
      "gridPos": {"x": 4, "y": 0, "w": 4, "h": 4},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "table",
        "rawSql": "SELECT (mem_available_bytes / 1024.0 / 1024 / 1024)::numeric(10,2) AS value FROM host_metrics WHERE $__timeFilter(ts) ORDER BY ts DESC LIMIT 1",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "decgbytes",
          "color": {"mode": "thresholds"},
          "thresholds": {"steps": [{"value": null, "color": "red"}, {"value": 1, "color": "yellow"}, {"value": 2, "color": "green"}]}
        }
      }
    },
    {
      "type": "stat",
      "title": "Load average (1m)",
      "gridPos": {"x": 8, "y": 0, "w": 4, "h": 4},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "table",
        "rawSql": "SELECT load_1::numeric(10,2) AS value FROM host_metrics WHERE $__timeFilter(ts) ORDER BY ts DESC LIMIT 1",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "color": {"mode": "thresholds"},
          "thresholds": {"steps": [{"value": null, "color": "green"}, {"value": 4, "color": "yellow"}, {"value": 8, "color": "red"}]}
        }
      }
    },
    {
      "type": "stat",
      "title": "Swap used",
      "gridPos": {"x": 12, "y": 0, "w": 4, "h": 4},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "table",
        "rawSql": "SELECT (swap_used_bytes / 1024.0 / 1024 / 1024)::numeric(10,2) AS value FROM host_metrics WHERE $__timeFilter(ts) ORDER BY ts DESC LIMIT 1",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "decgbytes",
          "color": {"mode": "thresholds"},
          "thresholds": {"steps": [{"value": null, "color": "green"}, {"value": 0.5, "color": "yellow"}, {"value": 1, "color": "red"}]}
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Host memory (GB)",
      "gridPos": {"x": 0, "y": 4, "w": 12, "h": 8},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "time_series",
        "rawSql": "SELECT ts AS time, 'used' AS metric, (mem_used_bytes / 1024.0 / 1024 / 1024) AS value FROM host_metrics WHERE $__timeFilter(ts) UNION ALL SELECT ts, 'available', (mem_available_bytes / 1024.0 / 1024 / 1024) FROM host_metrics WHERE $__timeFilter(ts) ORDER BY time",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "decgbytes",
          "custom": {"fillOpacity": 10, "stacking": {"mode": "none"}}
        },
        "overrides": [
          {"matcher": {"id": "byName", "options": "available"}, "properties": [{"id": "color", "value": {"mode": "fixed", "fixedColor": "green"}}]}
        ]
      }
    },
    {
      "type": "timeseries",
      "title": "Host load average",
      "gridPos": {"x": 12, "y": 4, "w": 12, "h": 8},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "time_series",
        "rawSql": "SELECT ts AS time, 'load_1m' AS metric, load_1 AS value FROM host_metrics WHERE $__timeFilter(ts) UNION ALL SELECT ts, 'load_5m', load_5 FROM host_metrics WHERE $__timeFilter(ts) UNION ALL SELECT ts, 'load_15m', load_15 FROM host_metrics WHERE $__timeFilter(ts) ORDER BY time",
        "refId": "A"
      }]
    },
    {
      "type": "timeseries",
      "title": "Container memory (MB)",
      "gridPos": {"x": 0, "y": 12, "w": 12, "h": 8},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "time_series",
        "rawSql": "SELECT ts AS time, container_name AS metric, (mem_usage_bytes / 1024.0 / 1024) AS value FROM container_metrics WHERE $__timeFilter(ts) ORDER BY ts",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "decmbytes",
          "custom": {"fillOpacity": 10}
        }
      }
    },
    {
      "type": "timeseries",
      "title": "Container CPU %",
      "gridPos": {"x": 12, "y": 12, "w": 12, "h": 8},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "time_series",
        "rawSql": "SELECT ts AS time, container_name AS metric, cpu_pct AS value FROM container_metrics WHERE $__timeFilter(ts) ORDER BY ts",
        "refId": "A"
      }],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "min": 0,
          "max": 100,
          "custom": {"fillOpacity": 10}
        }
      }
    },
    {
      "type": "table",
      "title": "Containers (latest)",
      "gridPos": {"x": 0, "y": 20, "w": 24, "h": 8},
      "datasource": {"type": "postgres", "uid": "openfdd_timescale"},
      "targets": [{
        "format": "table",
        "rawSql": "SELECT container_name, ROUND(cpu_pct::numeric, 1) AS \"CPU %\", ROUND((mem_usage_bytes/1024.0/1024)::numeric, 1) AS \"Mem MB\", mem_pct AS \"Mem %\", pids AS \"PIDs\" FROM container_metrics WHERE ts = (SELECT MAX(ts) FROM container_metrics) ORDER BY mem_usage_bytes DESC",
        "refId": "A"
      }],
      "options": {"showHeader": true}
    }
  ]
}
